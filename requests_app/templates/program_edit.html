{% extends 'base.html' %}

{% block content %}
<h1 class="text-3xl font-bold mb-4">Edit Program</h1>

<h2 class="text-2xl font-bold mt-8 mb-4">Edit Program Details</h2>
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="bg-blue-500 text-white px-4 py-2">Save</button>
    <a href="{% url 'program_detail' program.id %}" class="text-blue-500 hover:underline">Cancel</a>
</form>

<h2 class="text-2xl font-bold mt-8 mb-4">Members</h2>
<ul>
    {% for member, member_form in members_and_forms %}
    <li class="mb-2">
        {{ member.user.username }} ({{ member.member_type.type_name }})
        <form method="post" action="{% url 'edit_member' member.id %}" class="inline">
            {% csrf_token %}
            {{ member_form }}
            <button type="submit" class="bg-blue-500 text-white px-2 py-1">Change</button>
        </form>
        <form method="post" action="{% url 'remove_member' member.id %}" class="inline">
            {% csrf_token %}
            <button type="submit" class="bg-red-500 text-white px-2 py-1">Remove</button>
        </form>
    </li>
    {% endfor %}
</ul>

<h2 class="text-2xl font-bold mt-8 mb-4">Add Member</h2>

<button type="button" class="bg-blue-500 text-white px-4 py-2" onclick="openAddMemberModal();">Add Member</button>
<!-- Add Member Modal -->
<div class="modal" id="addMemberModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Add Member</p>
            <button class="delete" aria-label="close" id="closeAddMemberModal"></button>
        </header>
        <section class="modal-card-body">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Member Type</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in non_members %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>
                            <select class="select">
                                {% for member_type in member_form.fields.member_type.choices %}
                                <option value="{{ member_type.0 }}">{{ member_type.1 }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <button class="button is-primary add-button" data-user-id="{{ user.pk }}">Add</button>
                            <button class="button is-danger remove-button is-hidden"
                                data-user-id="{{ user.pk }}">Remove</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" id="submitAddMembers">OK</button>
            <button class="button" id="cancelAddMembers">Cancel</button>
        </footer>
    </div>
</div>



<script>
    function openAddMemberModal() {
        document.getElementById("addMemberModal").classList.remove("hidden");
    }

    function closeAddMemberModal() {
        document.getElementById("addMemberModal").classList.add("hidden");
    }
    document.addEventListener("DOMContentLoaded", function () {
        // Add event listeners for Add Member Modal
        const addMemberButton = document.querySelector("#addMember");
        const closeAddMemberModal = document.querySelector("#closeAddMemberModal");
        const addMemberModal = document.querySelector("#addMemberModal");
        const cancelButton = document.querySelector("#cancelAddMembers");
        const submitButton = document.querySelector("#submitAddMembers");

        addMemberButton.addEventListener("click", () => {
            addMemberModal.classList.add("is-active");
        });

        closeAddMemberModal.addEventListener("click", () => {
            addMemberModal.classList.remove("is-active");
        });

        cancelButton.addEventListener("click", () => {
            addMemberModal.classList.remove("is-active");
        });

        // Toggle Add/Remove buttons
        const addButtons = document.querySelectorAll(".add-button");
        const removeButtons = document.querySelectorAll(".remove-button");

        addButtons.forEach((button) => {
            button.addEventListener("click", () => {
                button.classList.add("is-hidden");
                button.nextElementSibling.classList.remove("is-hidden");
            });
        });

        removeButtons.forEach((button) => {
            button.addEventListener("click", () => {
                button.classList.add("is-hidden");
                button.previousElementSibling.classList.remove("is-hidden");
            });
        });

        // Handle form submission
        submitButton.addEventListener("click", () => {
            const formData = new FormData();
            const programId = document.querySelector("[name=program_id]").value;

            document.querySelectorAll("tbody tr").forEach((row) => {
                const addButton = row.querySelector(".add-button");
                const removeButton = row.querySelector(".remove-button");
                const select = row.querySelector("select");

                if (removeButton.classList.contains("is-hidden")) {
                    formData.append("user_ids[]", addButton.dataset.userId);
                    formData.append("member_types[]", select.value);
                }
            });

            fetch(`/programs/${programId}/add_members/`, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                },
            })
                .then((response) => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert("An error occurred while adding members.");
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred while adding members.");
                });
        });
    });
</script>
{% endblock %}